<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Servo Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
  h1 { text-align: center; margin-bottom: 20px; }
  .groups, .servos { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; justify-content: center; }
  .group, .servo { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); min-width: 150px; text-align: center; }
  .group button, .servo button { margin-top: 5px; width: 100%; padding: 8px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
  .on { background: #4caf50; color: white; }
  .off { background: #f44336; color: white; }
  input[type=text] { width: 100%; padding: 5px; border-radius: 5px; border: 1px solid #ccc; margin-bottom: 5px; }
  select { width: 100%; padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
  #addGroup { padding: 8px 12px; border-radius: 5px; border: none; background: #2196f3; color: white; cursor: pointer; margin-bottom: 20px; }
</style>
</head>
<body>
<h1>Servo Dashboard</h1>

<div style="text-align:center;">
  <button id="addGroup">+ Gruppe hinzufügen</button>
</div>

<div class="groups" id="groups"></div>

<h2 style="text-align:center;">Servos</h2>
<div class="servos" id="servos"></div>

<script defer>
// Dein Blynk Auth Token
const token = "BmmlidjZqiiEfbddzmnQsp_yuHgGMphX";

// Standardgruppen
let groups = ["A","B","C"];
let servos = [
  {name:"Servo 1", group:"A", state:0},
  {name:"Servo 2", group:"A", state:0},
  {name:"Servo 3", group:"B", state:0},
  {name:"Servo 4", group:"B", state:0},
  {name:"Servo 5", group:"C", state:0},
  {name:"Servo 6", group:"C", state:0},
];

// ----------------- Gruppen rendern -----------------
function renderGroups(){
  const container = document.getElementById('groups');
  container.innerHTML='';
  groups.forEach(g=>{
    const div = document.createElement('div');
    div.className='group';
    div.innerHTML = `
      <h3>${g}</h3>
      <button onclick="toggleGroup('${g}')" class="group-toggle">Ein/Aus</button>
      <button onclick="tryRemoveGroup('${g}')" style="background:#f44336;color:white;margin-top:5px;">Löschen</button>
    `;
    container.appendChild(div);
  });
  renderServos();
}

// Gruppe schalten
function toggleGroup(g){
  const groupServos = servos.filter(s=>s.group===g);
  const newState = groupServos.some(s=>s.state===0)?1:0;
  groupServos.forEach(s=>{
    s.state=newState;
    const i=servos.indexOf(s);
    sendCommand(i,newState);
  });
  renderServos();
}

// Gruppe löschen
function tryRemoveGroup(g){
  const groupServos = servos.filter(s=>s.group===g);
  if(groupServos.length > 0){
    alert("Gruppe kann nicht gelöscht werden, solange Servos ihr zugeordnet sind!");
    return;
  }
  if(confirm(`Gruppe "${g}" wirklich löschen?`)){
    groups = groups.filter(x=>x!==g);
    renderGroups();
  }
}

// Neue Gruppe hinzufügen
document.getElementById('addGroup').addEventListener('click',()=>{
  const name = prompt("Gruppenname:");
  if(name && !groups.includes(name)){
    groups.push(name);
    renderGroups();
  }
});

// ----------------- Servos rendern -----------------
function renderServos(){
  const container = document.getElementById('servos');
  container.innerHTML='';
  servos.forEach((s,i)=>{
    const div = document.createElement('div');
    div.className='servo';
    let groupOptions = `<option value="">Keine</option>`;
    groups.forEach(g=>{
      groupOptions+=`<option value="${g}" ${s.group===g?"selected":""}>${g}</option>`;
    });
    div.innerHTML = `
      <input type="text" value="${s.name}" onchange="rename(${i},this.value)">
      <select onchange="setGroup(${i},this.value)">${groupOptions}</select>
      <button class="${s.state?'on':'off'}" onclick="toggle(${i})">${s.state?'Ein':'Aus'}</button>
    `;
    container.appendChild(div);
  });
}

// Servo-Funktionen
function rename(i,name){ servos[i].name=name; renderServos(); }
function setGroup(i,g){ servos[i].group=g; renderServos(); }
function toggle(i){
  servos[i].state = servos[i].state?0:1;
  renderServos(); // visuell sofort sichtbar, auch wenn offline
  sendCommand(i, servos[i].state); // versucht Blynk zu schalten
}

// ----------------- Blynk Cloud Request -----------------
function sendCommand(index,state){
  const vpin = "V" + (index+1);
  fetch(`https://blynk.cloud/external/api/update?token=${token}&${vpin}=${state}`, {mode:'no-cors'})
    .catch(e=>console.warn("Blynk offline oder CORS blockiert"));
}

// Initial laden
renderGroups();
renderServos();
</script>
</body>
</html>
